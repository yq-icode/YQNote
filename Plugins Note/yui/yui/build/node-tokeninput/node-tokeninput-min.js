/*
Copyright (c) 2010, Yahoo! Inc. All rights reserved.
Code licensed under the BSD License:
http://developer.yahoo.com/yui/license.html
version: 3.3.0pr1
build: 10
*/
YUI.add("node-tokeninput",function(C){var R=C.config.doc,F=C.Lang,P=C.Node,K=C.Array,J=C.bind(C.ClassNameManager.getClassName,null,"tokeninput"),O=8,M=46,E=40,H=13,Q=37,I=39,N=38,A={},D="delimiter",B="tokens",G="value";function L(){L.superclass.constructor.apply(this,arguments);}C.extend(L,C.Plugin.Base,{BOX_TEMPLATE:"<div/>",CONTENT_TEMPLATE:"<div/>",INPUT_TEMPLATE:'<input type="text" autocomplete="off">',ITEM_TEMPLATE:"<li/>",LIST_TEMPLATE:"<ul/>",REMOVE_TEMPLATE:'<a href="#" title="Remove"><span role="img">\u00D7</span></a>',initializer:function(T){var V={},U={},S;C.Object.each(L.CLASS_NAMES,function(X,W){U[W]="."+X;},this);V[O]=this._keyBackspace;V[M]=this._keyDelete;V[E]=this._keyDown;V[H]=this._keyEnter;V[Q]=this._keyLeft;V[I]=this._keyRight;V[N]=this._keyUp;this._host=this.get("host");this._keys=V;this._selectors=U;S=this._tokenizeValue(this._host,null,{all:true,updateUI:false});if(S){this.set(B,this.get(B).concat(S));}this._render();this._bind();this._sync();},destructor:function(){var S=this._events;while(S&&S.length){S.pop().detach();}},add:function(V,T){var W=[],S=[],U=this.get(B);V=F.isArray(V)?V:V.split(this.get(D));K.each(V,function(Y,X){Y=F.trim(Y);if(Y){W.push(Y);S.push(this._createItem({text:Y,token:true}));}},this);if(S.length&&W.length){S=C.all(S).toFrag();if((T||T===0)&&T<U.length){U=U.concat();U.splice.apply(U,[T,0].concat(W));this._tokenNodes.item(T).insert(S,"before");}else{U=U.concat(W);this._inputItem.insert(S,"before");}this._tokenNodes.refresh();this.set(B,U,{atomic:true});}return this;},clear:function(){this._tokenNodes.remove(true);this._tokenNodes.refresh();return this.set(B,[],{atomic:true});},remove:function(S){var T=this.get(B);T.splice(S,1);this._tokenNodes.item(S).remove(true);this._tokenNodes.refresh();return this.set(B,T,{atomic:true});},_bind:function(){var T=this._list,S=this._selectors;if(!this._events){this._events=[];}this._events.concat([this._boundingBox.after({blur:this._afterBlur,click:this._afterFocus,focus:this._afterFocus},null,this),T.delegate({blur:this._onTokenBlur,focus:this._onTokenFocus,mouseover:this._onTokenMouseOver,mouseout:this._onTokenMouseOut},S.token,this),T.delegate(C.UA.gecko?"keypress":"keydown",this._onKey,S.input+","+S.token,this),T.delegate("click",this._onRemoveClick,S.remove,this),this.after({fauxInputChange:this._afterFauxInputChange,removeButtonChange:this._afterRemoveButtonChange,tokensChange:this._afterTokensChange})]);},_clearItems:function(){this._list.all(this._selectors.item).remove(true);},_createItem:function(T){var V=L.CLASS_NAMES,U=P.create(this.ITEM_TEMPLATE),S;if(!T){T=A;}U.addClass(V.item);K.each(["editable","hidden","token"],function(W){if(T[W]){U.addClass(V[W]);}});if(T.editable){S=P.create(this.INPUT_TEMPLATE).addClass(V.input);S.on("valueChange",this._afterInputValueChange,this);U.append(S);}if(T.token){U.setAttrs({tabIndex:0,text:T.text||""});if(this.get("removeButton")){U.addClass(V.hasremove).append(P.create(this.REMOVE_TEMPLATE).addClass(V.remove).set("role","button"));}}return U;},_focusNext:function(U){var T=this._selectors,S;U=U.ancestor(T.item,true);S=U&&U.next(T.token);if(S){S.focus();}else{this._inputNode.focus();}return true;},_focusPrev:function(U){var S=this._selectors,T;U=U.ancestor(S.item,true);T=U&&U.previous(S.token);if(T){T.focus();}else{return false;}return true;},_getSelection:function(W){var U=P.getDOMNode(W),T={end:0,start:0},V,X,S;if("selectionStart" in U){T.start=U.selectionStart;T.end=U.selectionEnd;}else{if(U.createTextRange){X=U.value;V=X.length;S=R.selection.createRange().duplicate();S.moveEnd("character",V);T.start=S.text===""?V:X.lastIndexOf(S.text);S.moveStart("character",-V);T.end=S.text.length;}}return T;},_keyBackspace:function(V){var U=V.currentTarget,S,T;if(U.hasClass(L.CLASS_NAMES.input)){T=this._getSelection(U);if(T.start!==0||T.end!==0){return false;}return this._focusPrev(U);}U=U.ancestor(this._selectors.token,true);S=this._tokenNodes.indexOf(U);if(!U||S===-1){return false;}(this._focusPrev(U)||this._focusNext(U));this.remove(S);return true;},_keyDelete:function(U){var T=U.currentTarget,S;if(!T.hasClass(L.CLASS_NAMES.token)){return false;}S=this._tokenNodes.indexOf(T);if(S===-1){return false;}this._focusNext(T);this.remove(S);return true;},_keyDown:function(S){return this._keyRight(S);},_keyEnter:function(T){var S=F.trim(this._inputNode.get(G));if(!this.get("tokenizeOnEnter")||!S){return false;}this._tokenizeValue(null,null,{all:true});},_keyLeft:function(T){var S=T.currentTarget;if(S.hasClass(L.CLASS_NAMES.input)&&this._getSelection(S).start!==0){return false;}return this._focusPrev(S);},_keyRight:function(T){var S=T.currentTarget;if(S.hasClass(L.CLASS_NAMES.input)){return false;}return this._focusNext(S);},_keyUp:function(S){return this._keyLeft(S);},_refresh:function(){if(this._tokenNodes){this._tokenNodes.refresh();}else{this._tokenNodes=this._list.all(this._selectors.token);}},_render:function(){var U=L.CLASS_NAMES,T=P.create(this.BOX_TEMPLATE),S=P.create(this.CONTENT_TEMPLATE);S.addClass(U.content);T.addClass(U.box).addClass(U.os).set("tabIndex",-1).append(S);this._set("boundingBox",T);this._set("contentBox",S);this._boundingBox=T;this._contentBox=S;this._renderList();this._host.addClass(U.host).insert(T,"after");},_renderList:function(){var S=P.create(this.LIST_TEMPLATE);S.addClass(L.CLASS_NAMES.list);this._list=S;this._set("listNode",S);this._contentBox.append(S);},_setTokens:function(S){return K.filter(S,function(T){return !!F.trim(T);});},_sync:function(){var S=[],T=this.get(B);this._contentBox[this.get("fauxInput")?"addClass":"removeClass"](L.CLASS_NAMES.fauxinput);K.each(T,function(V,U){S.push(this._createItem({text:F.trim(V),token:true}));},this);this._inputItem=this._createItem({editable:true});this._inputNode=this._inputItem.one(this._selectors.input);this._set("inputNode",this._inputNode);S.push(this._inputItem);S=C.all(S).toFrag();this._clearItems();this._list.append(S);this._refresh();this._syncHost();},_syncHost:function(){this._host.set(G,this.get(B).join(this.get(D)));
},_tokenizeValue:function(T,U,S){var V;S=C.merge({updateUI:true},S||A);if(!T){T=this._inputNode;}if(!U&&U!==""){U=T.get(G);}V=U.split(this.get(D));if(S.all||V.length>1){if(S.all){U="";}else{U=F.trim(V.pop());}if(S.updateUI){T.set(G,U);if(V.length){this.add(V);}}}if(S.updateUI){T.setStyle("width",Math.max(5,U.length+3)+"ex");}return V;},_afterBlur:function(S){if(this.get("tokenizeOnBlur")){this._tokenizeValue(null,null,{all:true});}},_afterFauxInputChange:function(S){this._sync();},_afterFocus:function(T){var S=this;if(!T.target.ancestor(this._selectors.item,true)){setTimeout(function(){S._inputNode.focus();},1);}},_afterInputValueChange:function(S){this._tokenizeValue(S.currentTarget,S.newVal);},_afterRemoveButtonChange:function(S){this._sync();},_afterTokensChange:function(S){if(S.atomic){this._syncHost();}else{this._sync();}},_onKey:function(T){var S=this._keys[T.keyCode];if(S){if(S.call(this,T)!==false){T.preventDefault();}}},_onRemoveClick:function(T){var S=T.currentTarget.ancestor(this._selectors.item);T.preventDefault();this.remove(this._tokenNodes.indexOf(S));},_onTokenBlur:function(S){S.currentTarget.removeClass(L.CLASS_NAMES.focus);},_onTokenFocus:function(S){S.currentTarget.addClass(L.CLASS_NAMES.focus);},_onTokenMouseOut:function(S){S.currentTarget.removeClass(L.CLASS_NAMES.hover);},_onTokenMouseOver:function(S){S.currentTarget.addClass(L.CLASS_NAMES.hover);}},{NAME:"pluginTokenInput",NS:"tokenInput",ATTRS:{boundingBox:{readOnly:true},contentBox:{readOnly:true},delimiter:{value:","},fauxInput:{value:true},inputNode:{readOnly:true},listNode:{readOnly:true},removeButton:{value:!!C.UA.mobile},tokenizeOnBlur:{value:true},tokenizeOnEnter:{value:true},tokens:{setter:"_setTokens",value:[]}},CLASS_NAMES:{box:J(),content:J("content"),editable:J("editable"),fauxinput:J("fauxinput"),focus:J("focus"),hasremove:J("hasremove"),hidden:J("hidden"),host:J("host"),hover:J("hover"),input:J("input"),item:J("item"),list:J("list"),os:J(C.UA.os),remove:J("remove"),token:J("token")}});C.Plugin.TokenInput=L;},"3.3.0pr1",{requires:["array-extras","classnamemanager","event-focus","event-valuechange","node-event-delegate","node-pluginhost","node-style","plugin"]});